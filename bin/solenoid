#!/usr/bin/env node
var fs = require('fs'),
    path = require('path'),
    optimist = require('optimist'),
    winston = require('winston'),
    solenoid = require('../'),
    config = JSON.parse(fs.readFileSync(path.join(process.env.HOME, '.solenoidconf'))),
    options,
    action,
    argv;

argv = optimist
  .alias('u', 'app-user')
  .alias('a', 'app-name')
  .alias('e', 'app-env')
  .alias('v', 'app-version')
  .alias('p', 'pidfile')
  .argv;

options = {
  storage: config.storage,
  instruments: config.instruments,
  engines: config.engines,
  runDir: config.runDir
};

winston.add(winston.transports.File, { filename: '/root/solenoid.log' });

action = argv._[0];

if (argv.version || (argv.v && !action)) {
  console.log(JSON.parse(fs.readFileSync(path.join(__dirname, '..', 'package.json'))).version);
  process.exit(0);
}

if (['start', 'restart', 'stop'].indexOf(action) === -1) {
  winston.error('Action is required and must be either "start" or "stop"');
}

if (!argv.pidfile) {
  winston.error('PID file is required');
  process.exit(1);
}

options.pidFile = argv.pidfile;

if (action === 'start') {
  if (!argv['app-user'] || !argv['app-name'] || !argv['app-version']) {
    winston.error('Application name, user and version are required');
    process.exit(1);
  }

  options.app = {
    user: argv['app-user'],
    name: argv['app-name'],
    version: argv['app-version'],
    env: argv['app-env']
  };
  winston.info('Starting application...');
}
else {
  winston.info('Stopping application...');
}

solenoid[action](options, function (err) {
  if (err) {
    winston.error('Error: ' + err.message);
    return process.exit(1);
  }

  winston.info('Success:' + action);
});
